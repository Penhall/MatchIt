sequenceDiagram
    participant Frontend as Frontend
    participant LocalStorage as LocalStorage
    participant useApi as useApi Hook
    participant Server as Express Server
    participant AuthMiddleware as Auth Middleware
    participant Database as PostgreSQL
    
    Note over Frontend,Database: ğŸ” DIAGNÃ“STICO: 403 FORBIDDEN
    
    rect rgb(245, 255, 245)
        Note over Frontend: âœ… UsuÃ¡rio faz login
        Frontend->>LocalStorage: setItem('matchit_token', token)
        Note over LocalStorage: Token salvo no localStorage
    end
    
    rect rgb(255, 245, 245)
        Note over Frontend: âŒ Carregamento da pÃ¡gina
        Frontend->>useApi: loadCompletionStats()
        useApi->>LocalStorage: getItem('matchit_token')
        
        alt âŒ PROBLEMA 1: Token nÃ£o encontrado
            LocalStorage-->>useApi: null
            Note over useApi: Sem token = Sem Authorization header
        else âœ… Token encontrado
            LocalStorage-->>useApi: "eyJhbGciOiJIUzI1..."
            useApi->>Server: GET /api/style/completion-stats/76cdd...
            Note over useApi: Headers: { Authorization: "Bearer token" }
        end
    end
    
    rect rgb(255, 245, 245)
        Note over Server: ğŸ” Middleware de AutenticaÃ§Ã£o
        Server->>AuthMiddleware: authenticateToken()
        
        alt âŒ PROBLEMA 2: Header malformado
            Note over AuthMiddleware: authHeader nÃ£o comeÃ§a com "Bearer "
            AuthMiddleware-->>Server: 401 Unauthorized
        else âŒ PROBLEMA 3: JWT invÃ¡lido
            Note over AuthMiddleware: jwt.verify() falha
            AuthMiddleware-->>Server: 401 Unauthorized  
        else âŒ PROBLEMA 4: Campo errado no token
            Note over AuthMiddleware: decoded.userId vs decoded.id
            AuthMiddleware-->>Server: 401 Unauthorized
        else âŒ PROBLEMA 5: UsuÃ¡rio nÃ£o encontrado
            AuthMiddleware->>Database: SELECT * FROM users WHERE id = ?
            Database-->>AuthMiddleware: Empty result
            AuthMiddleware-->>Server: 401 Unauthorized
        else âŒ PROBLEMA 6: ValidaÃ§Ã£o de acesso
            Note over AuthMiddleware: req.params.userId !== req.user.id
            AuthMiddleware-->>Server: 403 Forbidden
        end
    end
    
    rect rgb(245, 255, 245)
        Note over Frontend,Database: âœ… SOLUÃ‡ÃƒO IMPLEMENTADA
        
        Note over Frontend: 1. âœ… useApi corrigido com debug
        Note over LocalStorage: 2. âœ… Token validado no localStorage  
        Note over useApi: 3. âœ… Authorization header correto
        Note over AuthMiddleware: 4. âœ… Middleware robusto com logs
        Note over AuthMiddleware: 5. âœ… Aceita userId e id no token
        Note over Server: 6. âœ… Endpoint sem restriÃ§Ã£o de userId
        
        Note over Frontend,Database: ğŸ§ª FLUXO APÃ“S CORREÃ‡ÃƒO
        Frontend->>useApi: loadCompletionStats()
        useApi->>LocalStorage: getItem('matchit_token')
        LocalStorage-->>useApi: âœ… "eyJhbGciOiJIUzI1..."
        useApi->>Server: GET /api/style/completion-stats/1
        Note over useApi: âœ… Headers: { Authorization: "Bearer token" }
        
        Server->>AuthMiddleware: authenticateToken()
        Note over AuthMiddleware: âœ… Token extraÃ­do corretamente
        Note over AuthMiddleware: âœ… JWT vÃ¡lido, payload extraÃ­do
        AuthMiddleware->>Database: SELECT * FROM users WHERE id = userId
        Database-->>AuthMiddleware: âœ… UsuÃ¡rio encontrado
        AuthMiddleware->>Server: âœ… req.user = { id, name, email }
        
        Server-->>useApi: âœ… 200 OK { data: statistics }
        useApi-->>Frontend: âœ… EstatÃ­sticas carregadas
        Note over Frontend: âœ… StyleAdjustmentScreen funciona!
    end