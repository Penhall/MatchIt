// server/app.js - Servidor principal MatchIt (ES Modules)
import express from 'express';
import cors from 'cors';

const app = express();
const PORT = process.env.PORT || 3000;

console.log('ğŸš€ Iniciando servidor MatchIt (ES Modules)...');

// Middleware bÃ¡sico
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// Log de requests em desenvolvimento
if (process.env.NODE_ENV !== 'production') {
    app.use((req, res, next) => {
        console.log(`ğŸ“ ${req.method} ${req.path} - ${new Date().toISOString()}`);
        next();
    });
}

// Rota de health check
app.get('/api/health', (req, res) => {
    res.json({
        status: 'healthy',
        message: 'MatchIt API funcionando (ES Modules)',
        timestamp: new Date().toISOString(),
        version: '1.0.0',
        moduleType: 'ES Modules',
        endpoints: [
            'GET /api/health',
            'GET /api/profile',
            'GET /api/profile/style-preferences',
            'GET /api/tournament/categories',
            'POST /api/tournament/start'
        ]
    });
});

// Rota de informaÃ§Ãµes da API
app.get('/api/info', (req, res) => {
    res.json({
        name: 'MatchIt API',
        version: '1.0.0',
        description: 'Sistema de compatibilidade com torneios por imagens',
        moduleType: 'ES Modules',
        features: [
            'Sistema de preferÃªncias de estilo (Fase 0)',
            'Torneios de imagens 2x2 (Fase 1)',
            'AutenticaÃ§Ã£o JWT',
            'API RESTful'
        ],
        timestamp: new Date().toISOString()
    });
});

// Carregar rotas dinamicamente
async function loadRoutes() {
    try {
        // Carregar rotas de perfil
        const { default: profileRoutes } = await import('./routes/profile.js');
        app.use('/api/profile', profileRoutes);
        console.log('âœ… Rotas de perfil carregadas');
    } catch (error) {
        console.warn('âš ï¸  Rotas de perfil nÃ£o carregadas:', error.message);
    }

    try {
        // Carregar rotas de torneio
        const { default: tournamentRoutes } = await import('./routes/tournament.js');
        app.use('/api/tournament', tournamentRoutes);
        console.log('âœ… Rotas de torneio carregadas');
    } catch (error) {
        console.warn('âš ï¸  Rotas de torneio nÃ£o carregadas:', error.message);
    }
}

// Middleware de erro global
app.use((error, req, res, next) => {
    console.error('âŒ Erro global:', error);
    res.status(500).json({
        success: false,
        error: 'Erro interno do servidor',
        code: 'INTERNAL_SERVER_ERROR',
        timestamp: new Date().toISOString()
    });
});

// Rota 404 para endpoints nÃ£o encontrados
app.use('*', (req, res) => {
    res.status(404).json({
        success: false,
        error: 'Endpoint nÃ£o encontrado',
        path: req.originalUrl,
        method: req.method,
        availableEndpoints: [
            'GET /api/health',
            'GET /api/info',
            'GET /api/profile',
            'GET /api/profile/style-preferences',
            'GET /api/tournament/categories',
            'POST /api/tournament/start'
        ],
        timestamp: new Date().toISOString()
    });
});

// Inicializar servidor
async function startServer() {
    try {
        // Carregar todas as rotas
        await loadRoutes();
        
        // Iniciar servidor
        app.listen(PORT, () => {
            console.log(`ğŸš€ Servidor rodando na porta ${PORT}`);
            console.log(`ğŸŒ Health check: http://localhost:${PORT}/api/health`);
            console.log(`ğŸ“‹ API Info: http://localhost:${PORT}/api/info`);
            console.log(`ğŸ“‹ Endpoints disponÃ­veis:`);
            console.log(`   GET  /api/health`);
            console.log(`   GET  /api/info`);
            console.log(`   GET  /api/profile`);
            console.log(`   GET  /api/profile/style-preferences`);
            console.log(`   GET  /api/tournament/categories`);
            console.log(`   POST /api/tournament/start`);
            console.log(`   POST /api/tournament/choice`);
            console.log(`\nğŸ’¡ Sistema usando ES Modules puro!`);
        });
    } catch (error) {
        console.error('âŒ Erro ao iniciar servidor:', error);
        process.exit(1);
    }
}

// Iniciar aplicaÃ§Ã£o
startServer();

export default app;
