#!/bin/bash
# scripts/diagnose-matchit-project.sh - Script completo de diagnÃ³stico do projeto MatchIt

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Contadores
found_files=0
missing_files=0
critical_missing=0
typescript_errors=0
suggestions=()
backup_suggestions=()

# FunÃ§Ã£o para procurar arquivos na pasta backup
find_in_backup() {
    local target_file=$1
    local filename=$(basename "$target_file")
    
    # Procurar em backup/ e subpastas
    if [[ -d "backup" ]]; then
        # Procura exata pelo nome do arquivo
        local exact_match=$(find backup -name "$filename" -type f 2>/dev/null | head -1)
        if [[ -n "$exact_match" ]]; then
            echo "$exact_match"
            return 0
        fi
        
        # Se nÃ£o encontrar exato, procura por padrÃµes similares
        local pattern_match=$(find backup -name "*${filename%.*}*" -type f 2>/dev/null | head -1)
        if [[ -n "$pattern_match" ]]; then
            echo "$pattern_match"
            return 0
        fi
    fi
    
    return 1
}

# FunÃ§Ã£o para verificar sintaxe TypeScript
check_typescript_syntax() {
    local file=$1
    if command -v npx &> /dev/null && [[ -f "tsconfig.json" ]]; then
        local errors=$(npx tsc --noEmit "$file" 2>&1 | grep -c "error")
        if [[ $errors -gt 0 ]]; then
            typescript_errors=$((typescript_errors + 1))
            echo "      âš ï¸  $errors erro(s) TypeScript detectado(s)"
        fi
    fi
}

# FunÃ§Ã£o para verificar arquivos
check_file() {
    local file=$1
    local description=$2
    local is_critical=${3:-false}
    
    if [[ -f "$file" ]]; then
        found_files=$((found_files + 1))
        echo "    âœ… $description: $file"
        if [[ "$file" == *.tsx ]] || [[ "$file" == *.ts ]]; then
            check_typescript_syntax "$file"
        fi
        return 0
    else
        # Procurar na pasta backup
        local backup_file=$(find_in_backup "$file")
        if [[ -n "$backup_file" ]]; then
            found_files=$((found_files + 1))
            echo "    ðŸ”„ $description: $file (ENCONTRADO EM BACKUP: $backup_file)"
            backup_suggestions+=("cp '$backup_file' '$file'")
            return 0
        else
            missing_files=$((missing_files + 1))
            if [[ "$is_critical" == "true" ]]; then
                echo "    âŒ $description: $file (CRÃTICO - nÃ£o encontrado nem em backup)"
                critical_missing=$((critical_missing + 1))
            else
                echo "    âš ï¸  $description: $file (nÃ£o encontrado nem em backup)"
            fi
            
            # Adicionar Ã  lista de sugestÃµes
            suggestions+=("Criar: $file")
            return 1
        fi
    fi
}

# FunÃ§Ã£o para verificar dependÃªncias
check_dependency() {
    local package=$1
    local description=$2
    
    if [[ -f "package.json" ]] && grep -q "\"$package\"" package.json; then
        echo "    âœ… $description: $package"
        return 0
    else
        echo "    âŒ $description: $package"
        suggestions+=("npm install $package")
        return 1
    fi
}

# FunÃ§Ã£o para verificar diretÃ³rios
check_directory() {
    local dir=$1
    local description=$2
    
    if [[ -d "$dir" ]]; then
        echo "    âœ… $description: $dir/"
        return 0
    else
        echo "    âŒ $description: $dir/"
        suggestions+=("mkdir -p $dir")
        return 1
    fi
}

# InÃ­cio do diagnÃ³stico
clear
echo -e "${CYAN}ðŸ” DIAGNÃ“STICO COMPLETO DO PROJETO MATCHIT${NC}"
echo "============================================="
echo "ðŸ“… Data: $(date)"
echo "ðŸ“‚ DiretÃ³rio: $(pwd)"

# Verificar pasta backup
if [[ -d "backup" ]]; then
    backup_files=$(find backup -type f | wc -l)
    echo -e "${GREEN}ðŸ”„ Pasta backup encontrada com $backup_files arquivos${NC}"
else
    echo -e "${YELLOW}âš ï¸  Pasta backup nÃ£o encontrada${NC}"
fi

echo ""

# 1. VerificaÃ§Ã£o de Estrutura Base
echo -e "${BLUE}ðŸ“ Verificando Estrutura Base:${NC}"
check_file "package.json" "ConfiguraÃ§Ã£o do Projeto" true
check_file "tsconfig.json" "ConfiguraÃ§Ã£o TypeScript" true
check_file "vite.config.ts" "ConfiguraÃ§Ã£o Vite"
check_file "index.html" "HTML Principal" true

echo ""

# 2. VerificaÃ§Ã£o de DiretÃ³rios
echo -e "${BLUE}ðŸ“‚ Verificando DiretÃ³rios:${NC}"
check_directory "src" "CÃ³digo Fonte"
check_directory "src/components" "Componentes"
check_directory "src/hooks" "Hooks Customizados"
check_directory "src/types" "DefiniÃ§Ãµes de Tipos"
check_directory "src/utils" "UtilitÃ¡rios"
check_directory "server" "Servidor Backend"

echo ""

# 3. VerificaÃ§Ã£o de Arquivos Principais
echo -e "${BLUE}ðŸš€ Verificando Arquivos Principais:${NC}"
check_file "src/main.tsx" "Entrada Principal" true
check_file "src/App.tsx" "Componente Principal" true
check_file "src/App.css" "CSS Principal"

# Procurar App.tsx em locais alternativos se nÃ£o encontrado
if [[ ! -f "src/App.tsx" ]]; then
    for alt_path in "App.tsx" "src/components/App.tsx" "components/App.tsx"; do
        if [[ -f "$alt_path" ]]; then
            echo "    ðŸ”„ App.tsx encontrado em: $alt_path"
            suggestions+=("mv '$alt_path' 'src/App.tsx'")
            break
        fi
    done
fi

echo ""

# 4. VerificaÃ§Ã£o de Hooks
echo -e "${BLUE}ðŸª Verificando Hooks Customizados:${NC}"
check_file "src/hooks/useAuth.ts" "Hook de AutenticaÃ§Ã£o" true
check_file "src/hooks/useApi.ts" "Hook de API" true
check_file "src/hooks/useTournament.ts" "Hook de Torneio" true

echo ""

# 5. VerificaÃ§Ã£o de InternacionalizaÃ§Ã£o
echo -e "${BLUE}ðŸŒ Verificando InternacionalizaÃ§Ã£o:${NC}"
check_file "src/i18n.ts" "ConfiguraÃ§Ã£o i18n" true
check_file "src/locales/pt-BR.json" "TraduÃ§Ãµes PT-BR" true
check_file "src/locales/en-US.json" "TraduÃ§Ãµes EN-US"

echo ""

# 6. VerificaÃ§Ã£o de Telas/Componentes
echo -e "${BLUE}ðŸ–¥ï¸  Verificando Telas/Componentes:${NC}"
check_file "src/components/TournamentScreen.tsx" "Tela de Torneio" true
check_file "src/components/TournamentScreen.css" "CSS da Tela de Torneio"
check_file "src/components/AdminTournamentPanel.tsx" "Painel Admin" true
check_file "src/components/AdminTournamentPanel.css" "CSS do Painel Admin"

# Verificar outros componentes que podem existir
for component in "LoginScreen.tsx" "UserProfile.tsx" "MatchDetails.tsx" "TeamManagement.tsx"; do
    if [[ -f "src/components/$component" ]] || [[ -n "$(find_in_backup "src/components/$component")" ]]; then
        check_file "src/components/$component" "Componente $component"
    fi
done

echo ""

# 7. VerificaÃ§Ã£o de Tipos TypeScript
echo -e "${BLUE}ðŸ“ Verificando Tipos TypeScript:${NC}"
check_file "src/types/index.ts" "DefiniÃ§Ãµes de Tipos" true
check_file "src/types/tournament.ts" "Tipos de Torneio"
check_file "src/types/user.ts" "Tipos de UsuÃ¡rio"

echo ""

# 8. VerificaÃ§Ã£o de DependÃªncias
echo -e "${BLUE}ðŸ“¦ Verificando DependÃªncias:${NC}"
if [[ -f "package.json" ]]; then
    check_dependency "react" "React"
    check_dependency "react-dom" "React DOM"
    check_dependency "react-router-dom" "React Router"
    check_dependency "typescript" "TypeScript"
    check_dependency "vite" "Vite"
    check_dependency "i18next" "i18next"
    check_dependency "react-i18next" "React i18next"
else
    echo "    âŒ package.json nÃ£o encontrado - nÃ£o Ã© possÃ­vel verificar dependÃªncias"
fi

echo ""

# 9. VerificaÃ§Ã£o de Backend
echo -e "${BLUE}âš™ï¸  Verificando Backend:${NC}"
check_file "server/index.js" "Servidor Principal"
check_file "server/package.json" "ConfiguraÃ§Ã£o do Servidor"
check_file "server/routes/tournaments.js" "Rotas de Torneios"
check_file "server/routes/auth.js" "Rotas de AutenticaÃ§Ã£o"

echo ""

# EstatÃ­sticas finais
echo -e "${PURPLE}ðŸ“Š ESTATÃSTICAS FINAIS:${NC}"
echo "   âœ… Arquivos encontrados: $found_files"
echo "   âŒ Arquivos faltando: $missing_files"
echo "   ðŸš¨ Arquivos crÃ­ticos faltando: $critical_missing"
echo "   âš ï¸  Erros TypeScript: $typescript_errors"

# Gerar relatÃ³rio
report_file="diagnostic_report_$(date +%Y%m%d_%H%M%S).txt"
echo ""
echo -e "${GREEN}ðŸ“„ Gerando relatÃ³rio: $report_file${NC}"

{
    echo "ðŸ” RELATÃ“RIO DE DIAGNÃ“STICO - PROJETO MATCHIT"
    echo "============================================="
    echo "ðŸ“… Data: $(date)"
    echo "ðŸ“‚ DiretÃ³rio: $(pwd)"
    echo ""
    
    echo "ðŸ“Š ESTATÃSTICAS:"
    echo "   âœ… Arquivos encontrados: $found_files"
    echo "   âŒ Arquivos faltando: $missing_files"
    echo "   ðŸš¨ Arquivos crÃ­ticos faltando: $critical_missing"
    echo "   âš ï¸  Erros TypeScript: $typescript_errors"
    echo ""
    
    echo "ðŸ“¦ ANÃLISE DO BACKUP:"
    if [[ -d "backup" ]]; then
        echo "   ðŸ“‚ Pasta backup encontrada"
        echo "   ðŸ“Š Total de arquivos: $(find backup -type f | wc -l)"
        echo ""
        echo "   ðŸ” Arquivos TypeScript/React encontrados no backup:"
        find backup -name "*.tsx" -o -name "*.ts" -o -name "*.jsx" -o -name "*.js" | while read file; do
            echo "      - $file"
        done
        echo ""
        echo "   ðŸŽ¨ Arquivos CSS encontrados no backup:"
        find backup -name "*.css" -o -name "*.scss" | while read file; do
            echo "      - $file"
        done
    else
        echo "   âŒ Pasta backup nÃ£o encontrada"
    fi
    
    echo ""
    
    # SugestÃµes de correÃ§Ã£o
    echo "ðŸ”§ SUGESTÃ•ES DE CORREÃ‡ÃƒO:"
    if [[ ${#suggestions[@]} -gt 0 ]]; then
        for suggestion in "${suggestions[@]}"; do
            echo "   - $suggestion"
        done
    else
        echo "   âœ… Nenhuma correÃ§Ã£o necessÃ¡ria!"
    fi
    
    # Comandos para restaurar do backup
    if [[ ${#backup_suggestions[@]} -gt 0 ]]; then
        echo ""
        echo "ðŸ”„ COMANDOS PARA RESTAURAR DO BACKUP:"
        for cmd in "${backup_suggestions[@]}"; do
            echo "   $cmd"
        done
        echo ""
        echo "ðŸ’¡ Execute todos os comandos de uma vez:"
        echo "   $(IFS=$'\n'; echo "${backup_suggestions[*]}" | tr '\n' ' && ')"
    fi
    
    echo ""
    echo "ðŸš€ PRÃ“XIMOS PASSOS:"
    echo "   1. Execute os comandos de backup listados acima"
    echo "   2. Instale as dependÃªncias faltantes"
    echo "   3. Crie os arquivos que nÃ£o foram encontrados"
    echo "   4. Execute 'npm run dev' para testar o projeto"
    
} > "$report_file"

echo -e "${GREEN}âœ… DiagnÃ³stico completo! Verifique o arquivo: $report_file${NC}"
echo ""
echo -e "${CYAN}ðŸš€ PRÃ“XIMOS PASSOS:${NC}"
echo "   1. Abra o relatÃ³rio: cat $report_file"
echo "   2. Execute os comandos de restauraÃ§Ã£o do backup"
echo "   3. Instale dependÃªncias: npm install"
echo "   4. Teste o projeto: npm run dev"

# Se hÃ¡ comandos de backup, mostrar eles aqui tambÃ©m
if [[ ${#backup_suggestions[@]} -gt 0 ]]; then
    echo ""
    echo -e "${YELLOW}ðŸ”„ COMANDOS PRONTOS PARA RESTAURAR DO BACKUP:${NC}"
    for cmd in "${backup_suggestions[@]}"; do
        echo "   $cmd"
    done
fi